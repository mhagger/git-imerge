#! /bin/sh

set -e
set -x

DESCRIPTION="git-imerge test repository"

modify() {
    filename="$1"
    text="$2"
    echo "$text" >"$filename" &&
    git add "$filename"
}

modify_buildable() {
    filename="$1"
    text="$2"
    cat > $filename << EOF
#include<stdio.h>

int main()
{
    $text
}
EOF
    git add "$filename"
}

BASE="$(dirname "$(cd $(dirname "$0") && pwd)")"
TMP="$BASE/t/tmp"

if test -d "$TMP"
then
    # Be very careful before running "rm -rf":
    if test "x$(cat "$TMP/.git/description")" = "x$DESCRIPTION"
    then
        echo "Removing directory $TMP" >&2
        rm -rf "$TMP"
    else
        echo "Directory $TMP already exists!" >&2
        exit 1
    fi
fi

mkdir -p "$TMP"
cd "$TMP"
git init
echo "$DESCRIPTION" >.git/description
git config user.name 'Loú User'
git config user.email 'luser@example.com'

modify a.txt 0
git commit -m 'm⇒0'

git checkout -b a --
for i in $(seq 8)
do
    modify a.txt $i
    git commit -m "a⇒$i"
done

git checkout -b b master --
for i in $(seq 5)
do
    modify b.txt $i
    git commit -m "b⇒$i"
done

git checkout -b c master --
for i in $(seq 3)
do
    modify c.txt $i
    git commit -m "c⇒$i"
done
modify conflict.txt "c version"
git commit -m "c conflict"
for i in $(seq 4 8)
do
    modify c.txt $i
    git commit -m "c⇒$i"
done

git checkout -b d master --
for i in $(seq 2)
do
    modify d.txt $i
    git commit -m "d⇒$i"
done
modify conflict.txt "d version"
git commit -m "d conflict"
for i in $(seq 3 5)
do
    modify d.txt $i
    git commit -m "d⇒$i"
done

###############
# Build setup #
###############
git checkout -b build master --
modify_buildable hello.c printf\(\"0\\n\"\)\;
cat > make_script << EOF
#/bin/bash -ex
gcc -o hello hello.c
EOF
chmod +x make_script
git add make_script
git commit -m "Hello World"

git checkout -b build-left build --
for i in $(seq 10)
do
    modify_buildable hello.c 'printf("'$i' top\n");
    printf("'$i' bot\n");'
    git commit -m "build $i"
done

git checkout -b build-right build --
modify_buildable hello.c printf\(\"2\\n\"\)\;
git commit -m "Conflicts"
modify_buildable hello.c printf\(\"2\\n\"\;
git commit -m "Conflicts, breaks build"
modify_buildable hello.c 'printf("'2' top\n");
    printf("'2' bot\n");
    typo'
git commit -m "No conflict, breaks build"
for i in $(seq 4 6)
do
    modify_buildable hello.c printf\(\"$i\\n\"\)\;
    git commit -m "build $i"
done

git checkout master --

ln -s ../../imerge.css
